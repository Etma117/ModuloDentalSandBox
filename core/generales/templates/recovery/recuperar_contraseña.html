{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recuperación de Contraseña</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"></head>
<body>


    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title">Recuperación de Contraseña</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Por favor, ingresa tu nombre de usuario para recuperar tu contraseña.</p>
                        <!-- Formulario para solicitar el nombre de usuario -->
                        <form id="userRecoveryForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Nombre de usuario</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </form>
                    </div>
                </div>
    
                <!-- Contenedor para las preguntas de seguridad -->
                <div id="security-questions-container" class="card mt-4" style="display: none;">
                    <div class="card-body">
                        <h4 class="card-title">Preguntas de Seguridad</h4>
                        <form id="securityQuestionsForm">
                            <!-- Las preguntas se cargarán dinámicamente aquí -->
                        </form>
                    </div>
                </div>


                <!-- Contenedor para establecer nueva contraseña -->
                <div id="password-reset-container" class="card mt-4" style="display: none;">
                    <div class="card-body">
                        <h4 class="card-title">Establecer Nueva Contraseña</h4>
                        <form id="passwordResetForm">
                            <div class="mb-3">
                                <label for="new_password1" class="form-label">Nueva Contraseña</label>
                                <input type="password" class="form-control" id="new_password1" name="new_password1" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_password2" class="form-label">Confirmar Nueva Contraseña</label>
                                <input type="password" class="form-control" id="new_password2" name="new_password2" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Establecer Contraseña</button>
                        </form>
                    </div>
                </div>
                


            </div>
        </div>
    </div>

    <script>
        document.getElementById('userRecoveryForm').addEventListener('submit', function(event) {
            event.preventDefault();
            let formData = new FormData(this);
            let username = formData.get('username');

            fetch('/recover-password/', {  // Asegúrate de que esta ruta sea correcta
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',  // Asegúrate de obtener el token CSRF
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('security-questions-container').style.display = 'block';
                    let form = document.getElementById('securityQuestionsForm');
                    form.innerHTML = `
                        <div class="mb-3">
                            <label for="security_question_1" class="form-label">${data.pregunta_seguridad_1}</label>
                            <input type="text" class="form-control" id="security_answer_1" name="security_answer_1" required>
                        </div>
                        <div class="mb-3">
                            <label for="security_question_2" class="form-label">${data.pregunta_seguridad_2}</label>
                            <input type="text" class="form-control" id="security_answer_2" name="security_answer_2" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Verificar Respuestas</button>
                    `;
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // Añadir aquí la lógica de envío del formulario de preguntas de seguridad
        // ...
    </script>


<script>
    // Asumiendo que 'securityQuestionsForm' ha sido enviado y las respuestas verificadas,
    // aquí va la lógica para mostrar el formulario de restablecimiento de contraseña y enviarlo.
    document.getElementById('securityQuestionsForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let formData = new FormData(this);
        formData.append('username', document.getElementById('username').value);

        fetch('/verify-security-answers/', {  // Cambia a tu URL de verificación de respuestas
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // Asegúrate de obtener el token CSRF
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar el formulario para restablecer la contraseña
                document.getElementById('password-reset-container').style.display = 'block';
            } else {
                // Manejar errores, como respuestas incorrectas
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    document.getElementById('passwordResetForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let formData = new FormData(this);
        formData.append('username', document.getElementById('username').value);

        fetch('/set-new-password/', {  // Cambia a tu URL de actualización de contraseña
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // Asegúrate de obtener el token CSRF
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Contraseña actualizada correctamente
                alert('Tu contraseña ha sido actualizada exitosamente.');
                // Aquí puedes redirigir al usuario al login o realizar alguna otra acción
            } else {
                // Manejar errores
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>

</body>
</html>
